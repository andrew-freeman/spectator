<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Models - Llama Supervisor</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <main class="container">
      <header class="header">
        <h1>Models</h1>
        <nav class="nav">
          <a href="/">Home</a>
          <a href="/servers">Servers</a>
        </nav>
      </header>

      <section class="card">
        <h2>Access Token</h2>
        <div class="row">
          <input id="token-input" type="password" placeholder="Bearer token (optional)" />
          <button id="token-save" type="button">Save</button>
        </div>
      </section>

      <section class="card">
        <h2>Start Server</h2>
        <form id="start-form">
          <label>
            Model
            <select id="model-select"></select>
          </label>
          <label>
            GPU
            <select id="gpu-select">
              <option value="0">GPU 0</option>
              <option value="1">GPU 1</option>
              <option value="cpu">CPU-only</option>
            </select>
          </label>
          <label>
            Port
            <input id="port-input" type="number" value="8080" min="1" max="65535" />
          </label>
          <label>
            NGL
            <input id="ngl-input" type="number" value="99" min="0" />
          </label>
          <label class="checkbox">
            <input id="verbose-input" type="checkbox" />
            Verbose
          </label>
          <button type="submit">Start</button>
        </form>
        <pre id="start-output" class="output"></pre>
      </section>

      <section class="card">
        <h2>Model Root</h2>
        <div class="row">
          <input id="model-root-input" type="text" placeholder="/nvme_mod/models/" />
          <button id="model-root-save" type="button">Update</button>
        </div>
        <pre id="model-root-output" class="output"></pre>
      </section>

      <section class="card">
        <h2>Available Models</h2>
        <ul id="models-list" class="list"></ul>
      </section>
    </main>

    <script>
      const tokenInput = document.getElementById("token-input");
      const tokenSave = document.getElementById("token-save");
      const modelsList = document.getElementById("models-list");
      const modelSelect = document.getElementById("model-select");
      const gpuSelect = document.getElementById("gpu-select");
      const portInput = document.getElementById("port-input");
      const nglInput = document.getElementById("ngl-input");
      const verboseInput = document.getElementById("verbose-input");
      const startForm = document.getElementById("start-form");
      const startOutput = document.getElementById("start-output");
      const modelRootInput = document.getElementById("model-root-input");
      const modelRootSave = document.getElementById("model-root-save");
      const modelRootOutput = document.getElementById("model-root-output");

      function getToken() {
        return localStorage.getItem("llamaSupervisorToken") || "";
      }

      function setToken(value) {
        localStorage.setItem("llamaSupervisorToken", value);
      }

      function authHeaders() {
        const token = getToken();
        if (!token) return {};
        return { Authorization: `Bearer ${token}` };
      }

      tokenInput.value = getToken();
      tokenSave.addEventListener("click", () => {
        setToken(tokenInput.value.trim());
        startOutput.textContent = "Token saved.";
      });

      gpuSelect.addEventListener("change", () => {
        if (gpuSelect.value === "cpu") {
          nglInput.value = 0;
        } else if (Number(nglInput.value) === 0) {
          nglInput.value = 99;
        }
      });

      async function loadModels() {
        const response = await fetch("/api/models", { headers: authHeaders() });
        if (!response.ok) {
          const error = await response.json();
          startOutput.textContent = error.detail || "Failed to load models.";
          return;
        }
        const payload = await response.json();
        modelRootInput.value = payload.root;
        modelsList.innerHTML = "";
        modelSelect.innerHTML = "";
        payload.models.forEach((model) => {
          const item = document.createElement("li");
          item.textContent = `${model.path} (${Math.round(model.size_bytes / (1024 * 1024))} MB)`;
          modelsList.appendChild(item);
          const option = document.createElement("option");
          option.value = model.path;
          option.textContent = model.path;
          modelSelect.appendChild(option);
        });
      }

      modelRootSave.addEventListener("click", async () => {
        const root = modelRootInput.value.trim();
        if (!root) return;
        const response = await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ model_root: root }),
        });
        const payload = await response.json();
        if (!response.ok) {
          modelRootOutput.textContent = payload.detail || "Failed to update model root.";
          return;
        }
        modelRootOutput.textContent = `Updated: ${payload.model_root}`;
        loadModels();
      });

      startForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const gpu = gpuSelect.value === "cpu" ? null : Number(gpuSelect.value);
        const payload = {
          gpu,
          port: Number(portInput.value),
          host: "0.0.0.0",
          model: modelSelect.value,
          ngl: Number(nglInput.value),
          verbose: verboseInput.checked,
        };
        const response = await fetch("/api/servers/start", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!response.ok) {
          startOutput.textContent = data.detail || "Failed to start server.";
          return;
        }
        startOutput.textContent = JSON.stringify(data.server, null, 2);
      });

      loadModels();
    </script>
  </body>
</html>
